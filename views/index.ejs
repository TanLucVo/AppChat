<!DOCTYPE html>
<html>

<head>
	<title><%= title %></title>
	<link rel='stylesheet' href='/stylesheets/index.css' />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
		integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
		integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous">
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
		integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous">
	</script>
</head>

<body class="dark">
	<header class="header d-flex justify-content-between">
		<div class="left d-flex justify-content-between align-items-center">
			<h3 class="mb-0 logo">App chat</h3>
		</div>

		<div class="user d-flex justify-content-between align-items-center">
			<div class="user__image">
				<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
					alt="">
			</div>
			<span class="user__name">Tấn Lực</span>
		</div>
	</header>
	<div class="chat-container d-flex justify-content-between">
		<div class="left_chat">
			<div class="search">
				<input type="text" id="search-input" class="input_search_user">
				<span><i class="fas fa-search"></i></span>
				<div class="collapse" id="collapseSearch">
					<div class="card ps-0 pe-0 card-body collapseSearchCard">
						<div class="loading hide d-flex justify-content-center">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>
						<!-- <div class="user_search d-flex align-items-center ">
							<div class="user_search__img">
								<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
									alt="user">
							</div>
							<div class="user_search__name ms-2">
								<p class="mb-0">Ban: asdasd</p>
							</div>
						</div> -->

					</div>
					<button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
				</div>
			</div>
			<div class="user_left">
				<div class="user__left__item user_display d-flex align-items-center">
					<div class="user__left__item__img">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class="user__left__item__mess d-flex flex-column justify-content-center  align-items-baseline">
						<span class="partner_name">asdasdas</span>
						<span class="partner_mess">Ban: asdasd</span>
					</div>
				</div>
				<div class="user__left__item user_display d-flex align-items-center active">
					<div class="user__left__item__img">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class="user__left__item__mess d-flex flex-column justify-content-center  align-items-baseline">
						<span class="partner_name">asdasdas</span>
						<span class="partner_mess">Ban: asdasd</span>
					</div>
				</div>
			</div>
		</div>
		<div class="right_chat">
			<div class="room_name d-flex justify-content-between">
				<div class=" partner d-flex justify-content-between align-items-center">
					<div class="partner_image me-2">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class="ms-1 status d-flex flex-column ">
						<span class="partner_name">
							Sida
						</span>
						<span class="partner_stutus">
							Đang hoạt động
						</span>
					</div>
				</div>
				<p>icon j j đó</p>
			</div>
			<div class="room-container">
				<div class="you  d-flex align-items-end">
					<div class="your_image">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class=" your_message_group">
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">
								asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
							</div>
						</div>

					</div>
				</div>
				<div class="me">
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">
							asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
						</div>
					</div>
				</div>
				<div class="you  d-flex align-items-end">
					<div class="your_image">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class=" your_message_group">
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">
								asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
							</div>
						</div>

					</div>
				</div>
				<div class="me">
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">
							asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
						</div>
					</div>
				</div>
			</div>
			<form action="" class="form_chat d-flex justify-content-between align-items-center">
				<!-- <input type="text" class="input_chat"> -->
				<div class="input_container">
					<div class="input_chat" contenteditable="true"></div>
				</div>
				<a type="submit"><i class="fas fa-paper-plane"></i></a>
			</form>
		</div>
	</div>
</body>

<script>
	$('.input_chat').on('keydown', function (e) {
		if (e.keyCode === 13 && e.shiftKey === false) {
			console.log("gui")
			console.log($('.input_chat').html())
			return false;
		}
	});

	$(document).ready(function () {
		if ($(".chat-container")[0]) {

			const socket = io()
			socket.on('connect', () => {
				console.log("Da ket noi thanh cong voi id" + socket.id)

				socket.emit("register-id", "<%=userId %>")
			});
			socket.on('disconnect', () => {
				console.log("Mat ket noi voi server");
			});
			// socket.on('list-users', handleUserList);
			socket.on("register-id", data => {
				console.log(data)
			})

			$(document).click(function (event) {
				var clickover = $(event.target);
				var _opened = $("#collapseSearch").hasClass("show");
				if (_opened === true && !clickover.hasClass("collapseSearchCard") && !clickover.hasClass(
						"input_search_user")) {
					console.log("Hide")
					$("#collapseSearch").removeClass("show")
				}
			});
			var typingTimer; //timer identifier
			var doneTypingInterval = 800; //time in ms, 5 second for example

			$("#search-input").on("click focus", (function () {
				if ($("#search-input").val().trim() === "") return
				$("#collapseSearch").collapse("show")
			}))

			$("#search-input").on('keydown', function () {
				clearTimeout(typingTimer);
			});
			$("#search-input").keypress(async (event) => {
				typingTimer = setTimeout(loadAndDisplayUser, doneTypingInterval);
			})
			$("#search-input").keyup(async (event) => {

				if (event.which === 8 || event.which == 46) {
					typingTimer = setTimeout(loadAndDisplayUser, doneTypingInterval);

				}
			})
			$(document).on("click", ".user_display", async function () {
				let id = $(".user_display").data("id")
				let chatroom = $(".room-container[data-id=" + id + "]")
				//create message  container
				if (!chatroom[0]) {
					chatroom = document.createElement('div');
					chatroom.classList.add("room-container")
					chatroom.dataset.id = id
					chatroom = $(chatroom)
					loadAndDiaplayRoomByID(id)
				}




			});
			loadAndDiaplayRoom()
		}

	})
	async function loadAndDiaplayRoom() {
		//loadmessage
		try {
			let cookie = document.cookie
			cookie = cookie.replace("id=","")
			const response = await fetch("/api/getRoom", {
				method: 'POST',
				credentials: 'same-origin', // include, *same-origin, omit
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					id: cookie,
				})
			});
			let data = await response.json()
			console.log(data)
		} catch (error) {
			console.log(error)
		}

	}
	async function loadAndDiaplayRoomByID(id) {
		//loadmessage
		let cookie = document.cookie
			cookie = cookie.replace("id=","")
		const response = await fetch("/api/getRoomById", {
			method: 'POST',
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				id2: id,
			})
		});
		let data = await response.json()
		console.log(data)

	}
	async function loadAndDisplayUser() {
		setTimeout(() => {
			if (!$("#collapseSearch").hasClass("show")) {
				$("#collapseSearch").collapse("show")
			}
			$(".collapseSearchCard .loading").removeClass("hide")
			$(".collapseSearchCard").children().not(':first').remove();

			$(".collapseSearchCard").children().not(':first').promise().done(async function () {
				let query = $("#search-input").val().trim()
				if (query === "") {
					$(".collapseSearchCard .loading").addClass("hide")
					return
				}
				let string = ""
				try {

					const response = await fetch("/api/getUser", {
						method: 'POST',
						credentials: 'same-origin', // include, *same-origin, omit
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							query: query
						})
					});
					let data = await response.json()

					for (let i of data.data) {
						string += `<div class="user_search user_display d-flex align-items-center" data-id="${i.id}">
									<div class="user_search__img">
										<img src="${i.image}"
											alt="user">
									</div>
									<div class="user_search__name ms-2">
										<p class="mb-0">${i.name}</p>
									</div>
								</div>`
					}

					$(".collapseSearchCard").append(string)
					$(".collapseSearchCard .loading").addClass("hide")



				} catch (error) {
					$(".collapseSearchCard").append(string)
					$(".collapseSearchCard .loading").addClass("hide")
				}

			});
		}, 0);

	}

	function delay(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}
</script>

</html>