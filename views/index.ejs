<!DOCTYPE html>
<html>

<head>
	<title><%= title %></title>
	<link rel='stylesheet' href='/stylesheets/index.css' />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
		integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
		integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc" crossorigin="anonymous">
	</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
		integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous">
	</script>
	<script src="/javascript/main.js"></script>
</head>

<body class="dark">
	<header class="header d-flex justify-content-between">
		<div class="left d-flex justify-content-between align-items-center">
			<h3 class="mb-0 logo">App chat</h3>
		</div>

		<div class="user d-flex justify-content-between align-items-center">
			<div class="user__image">
				<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
					alt="">
			</div>
			<span class="user__name">Tấn Lực</span>
		</div>
	</header>
	<div class="chat-container d-flex justify-content-between">
		<div class="left_chat">
			<div class="search">
				<input type="text" id="search-input" class="input_search_user">
				<span><i class="fas fa-search"></i></span>
				<div class="collapse" id="collapseSearch">
					<div class="card ps-0 pe-0 card-body collapseSearchCard">
						<div class="loading hide d-flex justify-content-center">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>
						<!-- <div class="user_search d-flex align-items-center ">
							<div class="user_search__img">
								<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
									alt="user">
							</div>
							<div class="user_search__name ms-2">
								<p class="mb-0">Ban: asdasd</p>
							</div>
						</div> -->

					</div>
					<button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
				</div>
			</div>
			<div class="user_left">
				<div class="loading hide d-flex justify-content-center hide">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</div>
				<!-- <div class="user__left__item user_display d-flex align-items-center">
					<div class="user__left__item__img">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class="user__left__item__mess d-flex flex-column justify-content-center  align-items-baseline">
						<span class="partner_name">asdasdas</span>
						<span class="partner_mess">Ban: asdasd</span>
					</div>
				</div> -->

			</div>
		</div>
		<div class="right_chat">
			<div class="room_name hide d-flex justify-content-between">
				<div class=" partner d-flex justify-content-between align-items-center">
					<div class="partner_image me-2">
						<img src=""
							alt="user">
					</div>
					<div class="ms-1 status d-flex flex-column ">
						<span class="partner_name">
						</span>
						<span class="partner_stutus">
						</span>
					</div>
				</div>
				<p>icon j j đó</p>
			</div>
			<div class="room-container">

				<!-- <div class="you  d-flex align-items-end">
					<div class="your_image">
						<img src="https://www.hebergementwebs.com/image/ec/eca71f9e3aabc2c6af43482274a8189f.jpg/la-dragonball-house-edition-forbids-sharing-manga-images-and-gif-1.jpg"
							alt="user">
					</div>
					<div class=" your_message_group">
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">asdasd</div>
						</div>
						<div class="mess-container your_message">
							<div class="mess">
								asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
							</div>
						</div>

					</div>
				</div>
				<div class="me">
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">asdasd</div>
					</div>
					<div class="mess-container my_message">
						<div class="mess">
							asdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123dasdasasdsadsadaad1231231233123d
						</div>
					</div>
				</div> -->

			</div>
			<form action="" class="form_chat d-flex justify-content-between align-items-center">
				<!-- <input type="text" class="input_chat"> -->
				<div class="input_container">
					<div class="input_chat" contenteditable="true"></div>
				</div>
				<a type="submit"><i class="fas fa-paper-plane"></i></a>
			</form>
		</div>
	</div>
</body>

<script>
	$(document).ready(function () {
		if ($(".chat-container")[0]) {
			
			async function handleScrollLoadChat(){
				if($(".right_chat .room-container").scrollTop() === 0){
					console.log("Load more mess")
					let time =$(".right_chat .room-container .mess-container").first().data("time")
					let userId = $(".right_chat .room-container").data("userid")
					console.log(time)

					let moredata =await loadRoomByID(userId, time)
					// moredata = moredata.message.reverse()
					// console.log(moredata)
					// loadmorechat(moredata)
				}

			}
			
			let userOnline = [];
			const socket = io()
			socket.on('connect', () => {
				console.log("Da ket noi thanh cong voi id" + socket.id)
				socket.emit("register-id", "<%=userId %>")

			});
			socket.on('disconnect', () => {
				console.log("Mat ket noi voi server");
			});

			socket.on("register-id", data => {
				let {id, userId} = data;
				let user = userOnline.find(u => u.id==id)
				if(!user) return console.log("Khong tim thay user")
				user.userId = userId
				console.log(`client ${id} da dang ki userId ${userId}`)
			})

			socket.on("list-users", users => {
				console.log("Da nhan duoc danh sach user online")
				users.forEach(u=>{
					if(u.id !== socket.id){
						userOnline.push(u)
						console.log(u)
					}
				})
				console.log(userOnline)
			})
			socket.on("new-message", data => {
				console.log("Newmeessage")
				addChatPartner(data)
				$(".right_chat .room-container").animate({scrollTop: $(".right_chat .room-container").prop("scrollHeight")},0);
			})
			socket.on("new-user", data => {
				console.log("1 nguoi moi da tham gia")
				userOnline.push(data)
				console.log(userOnline)
			})
			socket.on("user-leave", id => {
				userOnline =userOnline.filter(e=>e.id !== id)
				console.log("1 nguoi moi da thoat")
				console.log(userOnline)
			})

			$(document).click(function (event) {
				var clickover = $(event.target);
				var _opened = $("#collapseSearch").hasClass("show");
				if (_opened === true && !clickover.hasClass("collapseSearchCard") && !clickover.hasClass(
						"input_search_user")) {
					console.log("Hide")
					$("#collapseSearch").removeClass("show")
				}
			});
			var typingTimer; //timer identifier
			var doneTypingInterval = 800; //time in ms, 5 second for example

			$("#search-input").on("click focus", (function () {
				if ($("#search-input").val().trim() === "") return
				$("#collapseSearch").collapse("show")
			}))

			$("#search-input").on('keydown', function () {
				clearTimeout(typingTimer);
			});
			$("#search-input").keypress(async (event) => {
				typingTimer = setTimeout(loadAndDisplayUser, doneTypingInterval);
			})
			$("#search-input").keyup(async (event) => {

				if (event.which === 8 || event.which == 46) {
					typingTimer = setTimeout(loadAndDisplayUser, doneTypingInterval);

				}
			})
			$(document).on("click", ".user_display", async function () {
				$(".right_chat .room_name").removeClass("hide")
				let userId = $(this).data("userid")
				let roomId = $(this).data("roomid")
				console.log(userId, roomId)

				$(".partner_image img").attr("src", $(this).children(".user__left__item__img").children().attr("src"))
				//create message  container
				$(".room_name .partner_name").text($(this).children(".user__left__item__mess").children(".partner_name").text())
				if($(".user_left  .room-container[data-roomid=" + roomId + "]")[0]){
					console.log("Co roi")
					let chatroom = $(".user_left  .room-container[data-roomid=" + roomId + "]")
					$(".right_chat .room-container").replaceWith(chatroom.clone())
					$(".right_chat .room-container").scroll(handleScrollLoadChat)

				}else{
					console.log("chua co")
					let newchatroom ;
					newchatroom = document.createElement('div');
					newchatroom.classList.add("room-container")
					newchatroom.dataset.userid = userId
					newchatroom.dataset.roomid = roomId
					newchatroom = $(newchatroom)
					$(".user_left").append(`<div class="room-container" data-userid=${userId} data-roomid=${roomId}></div>`)
					$(".right_chat .room-container").replaceWith(newchatroom)
					$(".right_chat .room-container").append(`<div class="loading-chat hide d-flex justify-content-center hide">
							<div class="spinner-border text-primary" role="status">
								<span class="visually-hidden">Loading...</span>
							</div>
						</div>`)
					let data  =await loadRoomByID(userId, null)
					let mess = data.message.reverse()
					$(".right_chat .room-container").children('.loading-chat').remove()
					
					displayChat(mess)
					$(".right_chat .room-container").scroll(handleScrollLoadChat)
				}
				// $(".room-container").scroll(handleScrollLoadChat)
				
				$(".right_chat .room-container").animate({scrollTop: $(".right_chat .room-container").prop("scrollHeight")},0);

				


				// $(".user_left").append(chatroom)

				
			});
			loadAndDiaplayRoom()
			$('.input_chat').on('keydown', function (e) {
				if (e.keyCode === 13 && e.shiftKey === false) {
					if($(".input_chat").text().trim() !== "" ){
						$(".form_chat").submit();
					}
					return false
				}
				
			});
			$(".form_chat ").submit(async e=>{
				e.preventDefault()
				let message = $(".input_chat").text().trim()
				if (message.trim() === "") {
						return 
				}
				$(".input_chat").text("")
				if($(".right_chat .room-container").children().last().hasClass("me")){
					let roomId = $(".right_chat .room-container").data("roomid")
					let chatroom = $(".room-container[data-roomid=" + roomId + "]")
					chatroom.children(".me").append(`<div class="mess-container my_message">
												<div class="mess">${message}</div>
											</div>`)
				}else{

					let roomId = $(".right_chat .room-container").data("roomid")
					let chatroom = $(".room-container[data-roomid=" + roomId + "]")

					chatroom.append(`<div class="me">
										<div class="mess-container my_message">
											<div class="mess">${message}</div>
										</div>
									</div>`)

				}
				$(".right_chat .room-container").animate({scrollTop: $(".right_chat .room-container").prop("scrollHeight")},0);

				const response = await fetch("/api/newMessage", {
					method: 'POST',
					credentials: 'same-origin', // include, *same-origin, omit
					headers: {
						'Content-Type': 'application/json'
					},
					body:JSON.stringify({
						message: message,
						roomId: $(".right_chat .room-container").data("roomid"),

					})

				});
				let data_mess = await response.json()
				if(response.status === 200){

					socket.emit('send-room',data_mess);
				}
			

				
			})
		}

	})


	
</script>

</html>